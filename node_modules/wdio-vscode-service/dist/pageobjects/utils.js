import semver from 'semver';
import { ContextMenu } from './index.js';
export function PageDecorator(locators) {
    return (ctor) => {
        for (const [prop, globalLocator] of Object.entries(locators)) {
            Object.defineProperties(ctor.prototype, {
                [`${prop}$`]: {
                    get: function () {
                        const locator = this.locators[prop] || globalLocator;
                        if (typeof locator === 'function') {
                            return (...args) => this.elem.$(locator(...args));
                        }
                        return this.elem.$(locator);
                    }
                },
                [`${prop}$$`]: {
                    get: function () {
                        const locator = this.locators[prop] || globalLocator;
                        if (typeof locator === 'function') {
                            return (...args) => this.elem.$$(locator(...args));
                        }
                        return this.elem.$$(locator);
                    }
                }
            });
        }
        Object.seal(ctor);
        Object.seal(ctor.prototype);
        return ctor;
    };
}
export class BasePage {
    /**
     * @private
     */
    constructor(_locators, _baseElem, _parentElem) {
        this._locators = _locators;
        this._baseElem = _baseElem;
        this._parentElem = _parentElem;
    }
    /**
     * Get the locator map of given page object
     */
    get locators() {
        if (Array.isArray(this.locatorKey)) {
            return this.locatorKey.reduce((prev, locatorKey) => ({
                ...prev,
                ...this._locators[locatorKey]
            }), {});
        }
        return this._locators[this.locatorKey];
    }
    /**
     * @private
     */
    get baseElem() {
        return this._baseElem;
    }
    /**
     * @private
     */
    get locatorMap() {
        return this._locators;
    }
    /**
     * Base element of given page object
     */
    get elem() {
        const baseLocator = this.locators.elem;
        if (this._baseElem) {
            return typeof this._baseElem === 'string'
                ? browser.$(this._baseElem)
                : this._baseElem;
        }
        if (typeof baseLocator === 'string') {
            return browser.$(baseLocator);
        }
        return browser.$('html');
    }
    /**
     * Parent element of given page object
     */
    get parent() {
        if (this._parentElem) {
            return typeof this._parentElem === 'string'
                ? browser.$(this._parentElem)
                : this._parentElem;
        }
        return browser.$('html');
    }
    /**
     * @private
     */
    setParentElement(parentElem) {
        this._parentElem = parentElem;
    }
    /**
     * Wait for the element to become visible
     * @param timeout custom timeout for the wait
     * @returns thenable self reference
     */
    async wait(timeout = 5000) {
        await this.elem.waitForDisplayed({ timeout });
        return this;
    }
    /**
     * Poll for the element to become visible
     * @param timeout custom timeout for the wait
     * @param interval custom interval to control polling
     * @returns thenable self reference
     */
    async poll(timeout = 10000, interval = 2000) {
        await this.elem.waitForDisplayed({ timeout, interval });
        return this;
    }
}
/**
 * Abstract element that has a context menu
 */
export class ElementWithContextMenu extends BasePage {
    /**
     * Open context menu on the element
     */
    async openContextMenu() {
        const contextMenuLocators = this.locatorMap.ContextMenu;
        const workbench = browser.$(this.locatorMap.Workbench.elem);
        const menus = await browser.$$(contextMenuLocators.contextView);
        if (menus.length < 1) {
            await this.elem.click({ button: 2 });
            await browser.$(contextMenuLocators.contextView).waitForExist({ timeout: 2000 });
            return new ContextMenu(this.locatorMap, workbench).wait();
        }
        if (await workbench.$$(contextMenuLocators.viewBlock).length > 0) {
            await this.elem.click({ button: 2 });
            await this.elem.waitForDisplayed({ reverse: true, timeout: 1000 });
        }
        await this.elem.click({ button: 2 });
        return new ContextMenu(this.locatorMap).wait();
    }
}
export function sleep(ms = 500) {
    return new Promise((res) => {
        setTimeout(res, ms);
    });
}
/**
 * Semver utility function that handles the special case where version is 'stable'
 * @param version The version to compare
 * @param targetVersion The target version to compare against
 * @returns true if version is 'stable' or if version >= targetVersion
 */
export function semverGte(version, targetVersion) {
    if (version === 'stable' || version === 'insiders') {
        return true;
    }
    return semver.gte(version, targetVersion);
}
/**
 * Semver utility function that handles the special case where version is 'stable'
 * @param version The version to compare
 * @param targetVersion The target version to compare against
 * @returns true if version is 'stable', otherwise returns version < targetVersion
 */
export function semverLt(version, targetVersion) {
    if (version === 'stable' || version === 'insiders') {
        return true;
    }
    return semver.lt(version, targetVersion);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcGFnZW9iamVjdHMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFBO0FBRzNCLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFvRHhDLE1BQU0sVUFBVSxhQUFhLENBQTZCLFFBQWtCO0lBQ3hFLE9BQU8sQ0FBQyxJQUFPLEVBQUUsRUFBRTtRQUNmLEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7WUFDM0QsTUFBTSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ3BDLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUFFO29CQUNWLEdBQUcsRUFBRTt3QkFDRCxNQUFNLE9BQU8sR0FBcUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxhQUFhLENBQUE7d0JBQ3RFLElBQUksT0FBTyxPQUFPLEtBQUssVUFBVSxFQUFFLENBQUM7NEJBQ2hDLE9BQU8sQ0FBQyxHQUFHLElBQWMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxDQUFXLENBQUMsQ0FBQTt3QkFDekUsQ0FBQzt3QkFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFBO29CQUMvQixDQUFDO2lCQUNKO2dCQUNELENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxFQUFFO29CQUNYLEdBQUcsRUFBRTt3QkFDRCxNQUFNLE9BQU8sR0FBcUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxhQUFhLENBQUE7d0JBQ3RFLElBQUksT0FBTyxPQUFPLEtBQUssVUFBVSxFQUFFLENBQUM7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QUFPLElBQUksQ0FBQTtJQUNmLENBQUM7SUFDRCxPQUFPLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFBO0FBQzVDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBvYmplY3Qtc2hvcnRoYW5kICovXG5pbXBvcnQgdHlwZSB7IENoYWluYWJsZVByb21pc2VFbGVtZW50LCBDaGFpbmFibGVQcm9taXNlQXJyYXkgfSBmcm9tICd3ZWJkcml2ZXJpbydcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJ1xuXG5pbXBvcnQgKiBhcyBhbGxMb2NhdG9yc1R5cGVzIGZyb20gJy4uL2xvY2F0b3JzL2luc2lkZXJzLmpzJ1xuaW1wb3J0IHsgQ29udGV4dE1lbnUgfSBmcm9tICcuL2luZGV4LmpzJ1xuXG50eXBlIENsYXNzV2l0aEZ1bmN0aW9uTG9jYXRvcnNBc1N0cmluZzxUPiA9IHtcbiAgICBba2V5IGluIGtleW9mIFQgYXMgVFtrZXldIGV4dGVuZHMgRnVuY3Rpb24gfCB1bmRlZmluZWQgPyBrZXkgOiBuZXZlcl06IFRba2V5XVxufVxuXG50eXBlIENsYXNzV2l0aEZ1bmN0aW9uTG9jYXRvcnMkPFQ+ID0ge1xuICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdGhpcyBmYWlscyBjb21waWxpbmcgaGVyZSBidXQgd29ya3Mgd2hlbiBhcHBsaWVkIHRvIGEgY2xhc3NcbiAgICBba2V5IGluIGtleW9mIENsYXNzV2l0aEZ1bmN0aW9uTG9jYXRvcnNBc1N0cmluZzxUPiBhcyBgJHtrZXl9JGBdOiAoXG4gICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdGhpcyBmYWlscyBjb21waWxpbmcgaGVyZSBidXQgd29ya3Mgd2hlbiBhcHBsaWVkIHRvIGEgY2xhc3NcbiAgICAgICAgLi4uYXJnczogUGFyYW1ldGVyczxDbGFzc1dpdGhGdW5jdGlvbkxvY2F0b3JzQXNTdHJpbmc8VD5ba2V5XT5cbiAgICApID0+IENoYWluYWJsZVByb21pc2VFbGVtZW50PFdlYmRyaXZlcklPLkVsZW1lbnQ+XG59XG5cbnR5cGUgQ2xhc3NXaXRoRnVuY3Rpb25Mb2NhdG9ycyQkPFQ+ID0ge1xuICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdGhpcyBmYWlscyBjb21waWxpbmcgaGVyZSBidXQgd29ya3Mgd2hlbiBhcHBsaWVkIHRvIGEgY2xhc3NcbiAgICBba2V5IGluIGtleW9mIENsYXNzV2l0aEZ1bmN0aW9uTG9jYXRvcnNBc1N0cmluZzxUPiBhcyBgJHtrZXl9JCRgXTogKFxuICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHRoaXMgZmFpbHMgY29tcGlsaW5nIGhlcmUgYnV0IHdvcmtzIHdoZW4gYXBwbGllZCB0byBhIGNsYXNzXG4gICAgICAgIC4uLmFyZ3M6IFBhcmFtZXRlcnM8Q2xhc3NXaXRoRnVuY3Rpb25Mb2NhdG9yc0FzU3RyaW5nPFQ+W2tleV0+XG4gICAgKSA9PiBDaGFpbmFibGVQcm9taXNlQXJyYXk8V2ViZHJpdmVySU8uRWxlbWVudFtdPlxufVxuXG50eXBlIENsYXNzV2l0aExvY2F0b3JzJDxUPiA9IHtcbiAgICBba2V5IGluIGtleW9mIFQgJiBzdHJpbmcgYXMgVFtrZXldIGV4dGVuZHMgU3RyaW5nIHwgdW5kZWZpbmVkXG4gICAgICAgID8gYCR7a2V5fSRgXG4gICAgICAgIDogbmV2ZXJdOiBDaGFpbmFibGVQcm9taXNlRWxlbWVudDxXZWJkcml2ZXJJTy5FbGVtZW50PlxufVxudHlwZSBDbGFzc1dpdGhMb2NhdG9ycyQkPFQ+ID0ge1xuICAgIFtrZXkgaW4ga2V5b2YgVCAmIHN0cmluZyBhcyBUW2tleV0gZXh0ZW5kcyBTdHJpbmcgfCB1bmRlZmluZWRcbiAgICAgICAgPyBgJHtrZXl9JCRgXG4gICAgICAgIDogbmV2ZXJdOiBDaGFpbmFibGVQcm9taXNlQXJyYXk8V2ViZHJpdmVySU8uRWxlbWVudFtdPlxufVxuXG50eXBlIExvY2F0b3JQcm9wZXJ0aWVzPFQ+ID0ge1xuICAgIHJlYWRvbmx5IGxvY2F0b3JNYXA6IEFsbExvY2F0b3JUeXBlLFxuICAgIHJlYWRvbmx5IGxvY2F0b3JzOiBUXG59XG5cbnR5cGUgQWxsTG9jYXRvclR5cGUgPSB0eXBlb2YgYWxsTG9jYXRvcnNUeXBlc1xuZXhwb3J0IHR5cGUgTG9jYXRvckNvbXBvbmVudHMgPSBrZXlvZiBBbGxMb2NhdG9yVHlwZSB8IChrZXlvZiBBbGxMb2NhdG9yVHlwZSlbXVxuZXhwb3J0IHR5cGUgTG9jYXRvcnMgPSBSZWNvcmQ8c3RyaW5nIHwgc3ltYm9sLCBzdHJpbmcgfCBGdW5jdGlvbj5cbmV4cG9ydCB0eXBlIFZTQ29kZUxvY2F0b3JNYXAgPSBSZWNvcmQ8a2V5b2YgQWxsTG9jYXRvclR5cGUsIExvY2F0b3JzPlxuZXhwb3J0IHR5cGUgSVBhZ2VEZWNvcmF0b3I8VD4gPSAoXG4gICAgQ2xhc3NXaXRoTG9jYXRvcnMkPFQ+ICYgQ2xhc3NXaXRoTG9jYXRvcnMkJDxUPiAmXG4gICAgQ2xhc3NXaXRoRnVuY3Rpb25Mb2NhdG9ycyQ8VD4gJiBDbGFzc1dpdGhGdW5jdGlvbkxvY2F0b3JzJCQ8VD5cbilcblxudHlwZSBQYWdlT2JqZWN0Q2xhc3MgPSB7XG4gICAgbmV3KC4uLmFyZ3M6IGFueVtdKTogYW55XG4gICAgW3N0YXRpY01ldGhvZDogc3RyaW5nXTogYW55XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBQYWdlRGVjb3JhdG9yPFQgZXh0ZW5kcyBQYWdlT2JqZWN0Q2xhc3M+IChsb2NhdG9yczogTG9jYXRvcnMpIHtcbiAgICByZXR1cm4gKGN0b3I6IFQpID0+IHtcbiAgICAgICAgZm9yIChjb25zdCBbcHJvcCwgZ2xvYmFsTG9jYXRvcl0gb2YgT2JqZWN0LmVudHJpZXMobG9jYXRvcnMpKSB7XG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhjdG9yLnByb3RvdHlwZSwge1xuICAgICAgICAgICAgICAgIFtgJHtwcm9wfSRgXToge1xuICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICh0aGlzOiBMb2NhdG9yUHJvcGVydGllczxhbnk+ICYgQmFzZVBhZ2U8YW55Pikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRvcjogTG9jYXRvcnNbc3RyaW5nXSA9IHRoaXMubG9jYXRvcnNbcHJvcF0gfHwgZ2xvYmFsTG9jYXRvclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsb2NhdG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICguLi5hcmdzOiBzdHJpbmdbXSkgPT4gdGhpcy5lbGVtLiQobG9jYXRvciguLi5hcmdzKSBhcyBzdHJpbmcpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbGVtLiQobG9jYXRvcilcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgW2Ake3Byb3B9JCRgXToge1xuICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICh0aGlzOiBMb2NhdG9yUHJvcGVydGllczxhbnk+ICYgQmFzZVBhZ2U8YW55Pikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYXRvcjogTG9jYXRvcnNbc3RyaW5nXSA9IHRoaXMubG9jYXRvcnNbcHJvcF0gfHwgZ2xvYmFsTG9jYXRvclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsb2NhdG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICguLi5hcmdzOiBzdHJpbmdbXSkgPT4gdGhpcy5lbGVtLiQkKGxvY2F0b3IoLi4uYXJncykgYXMgc3RyaW5nKVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWxlbS4kJChsb2NhdG9yKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIE9iamVjdC5zZWFsKGN0b3IpXG4gICAgICAgIE9iamVjdC5zZWFsKGN0b3IucHJvdG90eXBlKVxuICAgICAgICByZXR1cm4gY3RvclxuICAgIH1cbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEJhc2VQYWdlPFBhZ2VMb2NhdG9ycywgTG9jYXRvck1hcCBleHRlbmRzIFJlY29yZDxzdHJpbmcsIExvY2F0b3JzPiA9IFZTQ29kZUxvY2F0b3JNYXA+IHtcbiAgICAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGFic3RyYWN0IGxvY2F0b3JLZXk6IGtleW9mIExvY2F0b3JNYXAgfCAoa2V5b2YgTG9jYXRvck1hcClbXVxuXG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvciAoXG4gICAgICAgIHByb3RlY3RlZCBfbG9jYXRvcnM6IExvY2F0b3JNYXAsXG4gICAgICAgIHByaXZhdGUgX2Jhc2VFbGVtPzogc3RyaW5nIHwgQ2hhaW5hYmxlUHJvbWlzZUVsZW1lbnQ8V2ViZHJpdmVySU8uRWxlbWVudD4sXG4gICAgICAgIHByaXZhdGUgX3BhcmVudEVsZW0/OiBzdHJpbmcgfCBDaGFpbmFibGVQcm9taXNlRWxlbWVudDxXZWJkcml2ZXJJTy5FbGVtZW50PlxuICAgICkge31cblxuICAgIC8qKlxuICAgICAqIEdldCB0aGUgbG9jYXRvciBtYXAgb2YgZ2l2ZW4gcGFnZSBvYmplY3RcbiAgICAgKi9cbiAgICBnZXQgbG9jYXRvcnMgKCkge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmxvY2F0b3JLZXkpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhdG9yS2V5LnJlZHVjZSgocHJldiwgbG9jYXRvcktleSkgPT4gKHtcbiAgICAgICAgICAgICAgICAuLi5wcmV2LFxuICAgICAgICAgICAgICAgIC4uLnRoaXMuX2xvY2F0b3JzW2xvY2F0b3JLZXldXG4gICAgICAgICAgICB9IGFzIExvY2F0b3JzKSwge30gYXMgTG9jYXRvcnMpIGFzIGFueSBhcyBQYWdlTG9jYXRvcnNcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5fbG9jYXRvcnNbdGhpcy5sb2NhdG9yS2V5XSBhcyBhbnkgYXMgUGFnZUxvY2F0b3JzXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBnZXQgYmFzZUVsZW0gKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fYmFzZUVsZW1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGdldCBsb2NhdG9yTWFwICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xvY2F0b3JzXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQmFzZSBlbGVtZW50IG9mIGdpdmVuIHBhZ2Ugb2JqZWN0XG4gICAgICovXG4gICAgZ2V0IGVsZW0gKCkge1xuICAgICAgICBjb25zdCBiYXNlTG9jYXRvciA9ICh0aGlzLmxvY2F0b3JzIGFzIGFueSBhcyBMb2NhdG9ycykuZWxlbVxuICAgICAgICBpZiAodGhpcy5fYmFzZUVsZW0pIHtcbiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdGhpcy5fYmFzZUVsZW0gPT09ICdzdHJpbmcnXG4gICAgICAgICAgICAgICAgPyBicm93c2VyLiQodGhpcy5fYmFzZUVsZW0pXG4gICAgICAgICAgICAgICAgOiB0aGlzLl9iYXNlRWxlbVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiBiYXNlTG9jYXRvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHJldHVybiBicm93c2VyLiQoYmFzZUxvY2F0b3IpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYnJvd3Nlci4kKCdodG1sJylcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQYXJlbnQgZWxlbWVudCBvZiBnaXZlbiBwYWdlIG9iamVjdFxuICAgICAqL1xuICAgIGdldCBwYXJlbnQgKCkge1xuICAgICAgICBpZiAodGhpcy5fcGFyZW50RWxlbSkge1xuICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiB0aGlzLl9wYXJlbnRFbGVtID09PSAnc3RyaW5nJ1xuICAgICAgICAgICAgICAgID8gYnJvd3Nlci4kKHRoaXMuX3BhcmVudEVsZW0pXG4gICAgICAgICAgICAgICAgOiB0aGlzLl9wYXJlbnRFbGVtXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGJyb3dzZXIuJCgnaHRtbCcpXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBzZXRQYXJlbnRFbGVtZW50IChwYXJlbnRFbGVtOiBzdHJpbmcgfCBDaGFpbmFibGVQcm9taXNlRWxlbWVudDxXZWJkcml2ZXJJTy5FbGVtZW50Pikge1xuICAgICAgICB0aGlzLl9wYXJlbnRFbGVtID0gcGFyZW50RWxlbVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdhaXQgZm9yIHRoZSBlbGVtZW50IHRvIGJlY29tZSB2aXNpYmxlXG4gICAgICogQHBhcmFtIHRpbWVvdXQgY3VzdG9tIHRpbWVvdXQgZm9yIHRoZSB3YWl0XG4gICAgICogQHJldHVybnMgdGhlbmFibGUgc2VsZiByZWZlcmVuY2VcbiAgICAgKi9cbiAgICBhc3luYyB3YWl0ICh0aW1lb3V0ID0gNTAwMCk6IFByb21pc2U8dGhpcz4ge1xuICAgICAgICBhd2FpdCB0aGlzLmVsZW0ud2FpdEZvckRpc3BsYXllZCh7IHRpbWVvdXQgfSlcbiAgICAgICAgcmV0dXJuIHRoaXNcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQb2xsIGZvciB0aGUgZWxlbWVudCB0byBiZWNvbWUgdmlzaWJsZVxuICAgICAqIEBwYXJhbSB0aW1lb3V0IGN1c3RvbSB0aW1lb3V0IGZvciB0aGUgd2FpdFxuICAgICAqIEBwYXJhbSBpbnRlcnZhbCBjdXN0b20gaW50ZXJ2YWwgdG8gY29udHJvbCBwb2xsaW5nXG4gICAgICogQHJldHVybnMgdGhlbmFibGUgc2VsZiByZWZlcmVuY2VcbiAgICAgKi9cbiAgICBhc3luYyBwb2xsICh0aW1lb3V0ID0gMTAwMDAsIGludGVydmFsID0gMjAwMCk6IFByb21pc2U8dGhpcz4ge1xuICAgICAgICBhd2FpdCB0aGlzLmVsZW0ud2FpdEZvckRpc3BsYXllZCh7IHRpbWVvdXQsIGludGVydmFsIH0pXG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgfVxufVxuXG4vKipcbiAqIEFic3RyYWN0IGVsZW1lbnQgdGhhdCBoYXMgYSBjb250ZXh0IG1lbnVcbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEVsZW1lbnRXaXRoQ29udGV4dE1lbnU8VD4gZXh0ZW5kcyBCYXNlUGFnZTxUPiB7XG4gICAgLyoqXG4gICAgICogT3BlbiBjb250ZXh0IG1lbnUgb24gdGhlIGVsZW1lbnRcbiAgICAgKi9cbiAgICBhc3luYyBvcGVuQ29udGV4dE1lbnUgKCk6IFByb21pc2U8Q29udGV4dE1lbnU+IHtcbiAgICAgICAgY29uc3QgY29udGV4dE1lbnVMb2NhdG9ycyA9IHRoaXMubG9jYXRvck1hcC5Db250ZXh0TWVudSBhcyBBbGxMb2NhdG9yVHlwZVsnQ29udGV4dE1lbnUnXVxuICAgICAgICBjb25zdCB3b3JrYmVuY2ggPSBicm93c2VyLiQoKHRoaXMubG9jYXRvck1hcC5Xb3JrYmVuY2ggYXMgQWxsTG9jYXRvclR5cGVbJ1dvcmtiZW5jaCddKS5lbGVtKVxuICAgICAgICBjb25zdCBtZW51cyA9IGF3YWl0IGJyb3dzZXIuJCQoY29udGV4dE1lbnVMb2NhdG9ycy5jb250ZXh0VmlldylcblxuICAgICAgICBpZiAobWVudXMubGVuZ3RoIDwgMSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbGVtLmNsaWNrKHsgYnV0dG9uOiAyIH0pXG4gICAgICAgICAgICBhd2FpdCBicm93c2VyLiQoY29udGV4dE1lbnVMb2NhdG9ycy5jb250ZXh0Vmlldykud2FpdEZvckV4aXN0KHsgdGltZW91dDogMjAwMCB9KVxuICAgICAgICAgICAgcmV0dXJuIG5ldyBDb250ZXh0TWVudSh0aGlzLmxvY2F0b3JNYXAsIHdvcmtiZW5jaCkud2FpdCgpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoYXdhaXQgd29ya2JlbmNoLiQkKGNvbnRleHRNZW51TG9jYXRvcnMudmlld0Jsb2NrKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmVsZW0uY2xpY2soeyBidXR0b246IDIgfSlcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZWxlbS53YWl0Rm9yRGlzcGxheWVkKHsgcmV2ZXJzZTogdHJ1ZSwgdGltZW91dDogMTAwMCB9KVxuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5lbGVtLmNsaWNrKHsgYnV0dG9uOiAyIH0pXG4gICAgICAgIHJldHVybiBuZXcgQ29udGV4dE1lbnUodGhpcy5sb2NhdG9yTWFwKS53YWl0KClcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzbGVlcCAobXMgPSA1MDApIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlcykgPT4ge1xuICAgICAgICBzZXRUaW1lb3V0KHJlcywgbXMpXG4gICAgfSlcbn1cblxuLyoqXG4gKiBTZW12ZXIgdXRpbGl0eSBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgdGhlIHNwZWNpYWwgY2FzZSB3aGVyZSB2ZXJzaW9uIGlzICdzdGFibGUnXG4gKiBAcGFyYW0gdmVyc2lvbiBUaGUgdmVyc2lvbiB0byBjb21wYXJlXG4gKiBAcGFyYW0gdGFyZ2V0VmVyc2lvbiBUaGUgdGFyZ2V0IHZlcnNpb24gdG8gY29tcGFyZSBhZ2FpbnN0XG4gKiBAcmV0dXJucyB0cnVlIGlmIHZlcnNpb24gaXMgJ3N0YWJsZScgb3IgaWYgdmVyc2lvbiA+PSB0YXJnZXRWZXJzaW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZW12ZXJHdGUgKHZlcnNpb246IHN0cmluZywgdGFyZ2V0VmVyc2lvbjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKHZlcnNpb24gPT09ICdzdGFibGUnIHx8IHZlcnNpb24gPT09ICdpbnNpZGVycycpIHtcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG4gICAgcmV0dXJuIHNlbXZlci5ndGUodmVyc2lvbiwgdGFyZ2V0VmVyc2lvbilcbn1cblxuLyoqXG4gKiBTZW12ZXIgdXRpbGl0eSBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgdGhlIHNwZWNpYWwgY2FzZSB3aGVyZSB2ZXJzaW9uIGlzICdzdGFibGUnXG4gKiBAcGFyYW0gdmVyc2lvbiBUaGUgdmVyc2lvbiB0byBjb21wYXJlXG4gKiBAcGFyYW0gdGFyZ2V0VmVyc2lvbiBUaGUgdGFyZ2V0IHZlcnNpb24gdG8gY29tcGFyZSBhZ2FpbnN0XG4gKiBAcmV0dXJucyB0cnVlIGlmIHZlcnNpb24gaXMgJ3N0YWJsZScsIG90aGVyd2lzZSByZXR1cm5zIHZlcnNpb24gPCB0YXJnZXRWZXJzaW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZW12ZXJMdCAodmVyc2lvbjogc3RyaW5nLCB0YXJnZXRWZXJzaW9uOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAodmVyc2lvbiA9PT0gJ3N0YWJsZScgfHwgdmVyc2lvbiA9PT0gJ2luc2lkZXJzJykge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICByZXR1cm4gc2VtdmVyLmx0KHZlcnNpb24sIHRhcmdldFZlcnNpb24pXG59XG4iXX0=